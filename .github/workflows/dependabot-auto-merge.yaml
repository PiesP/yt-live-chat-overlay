name: ğŸ¤– Dependabot Auto-Merge

# Responsibility: Auto-merge safe dependabot PRs
# - GitHub Actions: patch/minor updates
# - npm (root package): patch/minor updates for specific safe groups
# - Requires CI to pass first

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  # Re-evaluate when check suites complete
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

# Concurrency control for sequential processing
concurrency:
  group: dependabot-auto-merge
  cancel-in-progress: false

jobs:
  auto-merge:
    name: ğŸ¤– Auto-Merge Dependabot
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Increased to accommodate check waiting time
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: ğŸ“¥ Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: â³ Wait for required checks
        id: wait-checks
        run: |
          echo "â³ Waiting for required CI and security checks..."

          # Required checks (must match job names in ci.yaml and security.yaml)
          REQUIRED_CHECKS=(
            "ğŸ§¹ Biome (Lint + Format)"
            "ğŸ§ª TypeScript Checks"
            "ğŸš€ Build"
            "ğŸ›¡ï¸ OSV Vulnerability Scan (PR Diff)"
            "ğŸ“œ License Check"
          )

          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            ALL_SUCCESS=true

            for check in "${REQUIRED_CHECKS[@]}"; do
              STATUS=$(gh pr checks "$PR_NUMBER" --json name,state --jq ".[] | select(.name == \"$check\") | .state" 2>/dev/null || echo "PENDING")

              if [ "$STATUS" == "FAILURE" ]; then
                echo "âŒ Check failed: $check"
                echo "checks_passed=false" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATUS" != "SUCCESS" ]; then
                ALL_SUCCESS=false
              fi
            done

            if [ "$ALL_SUCCESS" = true ]; then
              echo "âœ… All required checks passed"
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "â³ Waiting for checks to complete... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "â° Timeout waiting for checks"
          echo "checks_passed=false" >> $GITHUB_OUTPUT
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-merge GitHub Actions updates
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'github-actions' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          echo "ğŸ¤– Auto-merging GitHub Actions update"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-merge safe npm groups
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor') &&
          (contains(steps.dependabot-metadata.outputs.dependency-names, 'typescript') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@types/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@biomejs/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, 'vite'))
        run: |
          echo "ğŸ¤– Auto-merging safe npm group update"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â­ï¸ Skip critical packages or major updates
        if: >-
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' ||
          (steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
           contains(steps.dependabot-metadata.outputs.dependency-names, 'vite'))
        run: |
          echo "âš ï¸ Manual review required"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          echo "ğŸ“ Reason: Major update or critical package"

      - name: ğŸš¨ Notify on merge failure
        if: failure()
        run: |
          gh pr comment "$PR_NUMBER" --body "âš ï¸ **Auto-merge failed**

          Required checks did not pass or timed out. Please review manually.

          - Check CI pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Review security scan results
          - Verify no merge conflicts exist"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
