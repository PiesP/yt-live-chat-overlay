name: ğŸ¤– Dependabot Auto-Merge

# Responsibility: Auto-merge safe dependabot PRs
# - Package manager: pnpm (managed via npm ecosystem in dependabot)
# - Security updates: Auto-merge ALL updates (including major) if vulnerability detected
# - GitHub Actions: patch/minor updates
# - npm dependencies: patch/minor updates for safe groups (Biome, TypeScript, Vite)
# - Requires CI to pass first

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read

# Concurrency control for sequential processing
concurrency:
  group: dependabot-auto-merge
  cancel-in-progress: false

jobs:
  auto-merge:
    name: ğŸ¤– Auto-Merge Dependabot
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Increased to accommodate check waiting time
    if: github.actor == 'dependabot[bot]'
    env:
      GH_REPO: ${{ github.repository }}
    steps:
      - name: ğŸ“¥ Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: ğŸ” Check for security vulnerability
        id: security-check
        run: |
          echo "ğŸ” Checking if this is a security update..."

          # Check if PR has security label
          HAS_SECURITY_LABEL=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels | map(select(.name == "security")) | length')

          # Check alert-state from dependabot metadata
          ALERT_STATE="${{ steps.dependabot-metadata.outputs.alert-state }}"
          CVSS="${{ steps.dependabot-metadata.outputs.cvss }}"

          if [ "$HAS_SECURITY_LABEL" -gt 0 ] || [ -n "$ALERT_STATE" ]; then
            echo "ğŸš¨ Security vulnerability detected!"
            echo "   - Alert State: ${ALERT_STATE:-none}"
            echo "   - CVSS Score: ${CVSS:-unknown}"
            echo "   - Labels: Security label present"
            echo "is_security_update=true" >> $GITHUB_OUTPUT

            # Determine severity
            if [ -n "$CVSS" ]; then
              CVSS_NUM=$(echo "$CVSS" | grep -oP '\d+(\.\d+)?' | head -1 || echo "0")
              echo "severity_score=$CVSS_NUM" >> $GITHUB_OUTPUT

              # Use awk for floating point comparison (more portable than bc)
              HIGH=$(awk -v cvss="$CVSS_NUM" 'BEGIN {print (cvss >= 7.0)}')
              MEDIUM=$(awk -v cvss="$CVSS_NUM" 'BEGIN {print (cvss >= 4.0)}')

              if [ "$HIGH" = "1" ]; then
                echo "severity=high" >> $GITHUB_OUTPUT
                echo "âš ï¸ HIGH severity vulnerability (CVSS >= 7.0)"
              elif [ "$MEDIUM" = "1" ]; then
                echo "severity=medium" >> $GITHUB_OUTPUT
                echo "âš ï¸ MEDIUM severity vulnerability (CVSS >= 4.0)"
              else
                echo "severity=low" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ LOW severity vulnerability (CVSS < 4.0)"
              fi
            else
              echo "severity=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… Not a security update"
            echo "is_security_update=false" >> $GITHUB_OUTPUT
            echo "severity=none" >> $GITHUB_OUTPUT
          fi
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â³ Wait for required checks
        id: wait-checks
        run: |
          echo "â³ Waiting for required CI and security checks..."

          # Required checks (must match job names in ci.yaml and security.yaml)
          REQUIRED_CHECKS=(
            "ğŸ§¹ Biome (Lint + Format)"
            "ğŸ§ª TypeScript Checks"
            "ğŸš€ Build"
            "ğŸ›¡ï¸ OSV Vulnerability Scan (PR Diff)"
            "ğŸ“œ License Check"
          )

          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            ALL_SUCCESS=true

            for check in "${REQUIRED_CHECKS[@]}"; do
              STATUS=$(gh pr checks "$PR_NUMBER" --json name,state --jq ".[] | select(.name == \"$check\") | .state" 2>/dev/null || echo "PENDING")

              if [ "$STATUS" == "FAILURE" ]; then
                echo "âŒ Check failed: $check"
                echo "checks_passed=false" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATUS" != "SUCCESS" ]; then
                ALL_SUCCESS=false
              fi
            done

            if [ "$ALL_SUCCESS" = true ]; then
              echo "âœ… All required checks passed"
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "â³ Waiting for checks to complete... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "â° Timeout waiting for checks"
          echo "checks_passed=false" >> $GITHUB_OUTPUT
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ›¡ï¸ Auto-merge security updates
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.security-check.outputs.is_security_update == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'npm'
        run: |
          echo "ğŸ›¡ï¸ Auto-merging security update"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          echo "ğŸš¨ Severity: ${{ steps.security-check.outputs.severity }}"
          echo "ğŸ“ˆ CVSS Score: ${{ steps.security-check.outputs.severity_score }}"
          echo ""
          echo "âš ï¸ Security vulnerability detected - auto-merging regardless of semver"
          echo "   This includes major version updates if necessary for security"

          # Add comment explaining the auto-merge
          gh pr comment "$PR_NUMBER" --body "ğŸ›¡ï¸ **Security Update Auto-Merge**

          This PR addresses a security vulnerability and will be **automatically merged** after all checks pass.

          - **Severity**: ${{ steps.security-check.outputs.severity }}
          - **CVSS Score**: ${{ steps.security-check.outputs.severity_score }}
          - **Update Type**: ${{ steps.dependabot-metadata.outputs.update-type }}
          - **Package(s)**: ${{ steps.dependabot-metadata.outputs.dependency-names }}

          Security updates are prioritized and may include breaking changes. Please review the changes after merge and test thoroughly.

          ---
          *Auto-merge policy: All security updates are automatically merged to ensure timely vulnerability remediation.*"

          gh pr merge --auto --squash "$PR_URL"
          echo "âœ… Security update queued for auto-merge"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-merge GitHub Actions updates
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'github-actions' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          echo "ğŸ¤– Auto-merging GitHub Actions update"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Auto-merge safe npm groups
        if: >-
          steps.wait-checks.outputs.checks_passed == 'true' &&
          steps.security-check.outputs.is_security_update == 'false' &&
          steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor') &&
          (contains(steps.dependabot-metadata.outputs.dependency-names, 'typescript') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@types/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, '@biomejs/') ||
           contains(steps.dependabot-metadata.outputs.dependency-names, 'vite'))
        run: |
          echo "ğŸ¤– Auto-merging safe npm group update"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â­ï¸ Skip critical packages or major updates
        if: >-
          steps.security-check.outputs.is_security_update == 'false' &&
          (steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' ||
           (steps.dependabot-metadata.outputs.package-ecosystem == 'npm' &&
            contains(steps.dependabot-metadata.outputs.dependency-names, 'vite')))
        run: |
          echo "âš ï¸ Manual review required"
          echo "ğŸ“¦ Package: ${{ steps.dependabot-metadata.outputs.dependency-names }}"
          echo "ğŸ“Š Update type: ${{ steps.dependabot-metadata.outputs.update-type }}"
          echo "ğŸ“ Reason: Major update or critical package (not a security update)"

      - name: ğŸš¨ Notify on merge failure
        if: failure()
        run: |
          gh pr comment "$PR_NUMBER" --body "âš ï¸ **Auto-merge failed**

          Required checks did not pass or timed out. Please review manually.

          - Check CI pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Review security scan results
          - Verify no merge conflicts exist"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
