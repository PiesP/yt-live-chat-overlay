name: üöÄ Release

# Responsibility: Release artifact creation (Node.js + pnpm)
# - Version detection: git tag or manual trigger
# - Production build: userscript + checksums + metadata
# - GitHub Release: automated creation with downloadable assets
# - dist/ update: commit built scripts to 'release' branch for jsDelivr CDN
#
# Trigger: Tag push (v*) or manual dispatch

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3)"
        required: true
        type: string

env:
  NODE_VERSION: "24"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: üèóÔ∏è Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üìù Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"

      - name: üè∑Ô∏è Create Git tag (workflow_dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          set -euo pipefail
          TAG=v${{ steps.version.outputs.version }}
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists; skipping"
          else
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
            echo "‚úÖ Tag created: ${TAG}"
          fi

      - name: üèóÔ∏è Build userscript
        run: |
          BUILD_VERSION=${{ steps.version.outputs.version }} pnpm build
          # Backup dist for later steps (survives git checkout)
          mkdir -p /tmp/dist-backup
          cp -r dist/* /tmp/dist-backup/
          # Generate meta.js from userscript header
          awk 'BEGIN{p=0} /^\\/\\/ ==UserScript==/{p=1} {if(p) print} /^\\/\\/ ==\\/UserScript==/{exit}' /tmp/dist-backup/yt-live-chat-overlay.user.js > /tmp/dist-backup/yt-live-chat-overlay.meta.js
          # List backed up files for verification
          echo "üì¶ Built files:"
          ls -la /tmp/dist-backup/

      - name: üì¶ Prepare release package
        run: |
          mkdir -p release
          cp /tmp/dist-backup/yt-live-chat-overlay.user.js release/
          cp /tmp/dist-backup/yt-live-chat-overlay.meta.js release/

          # Generate checksums
          cd release && sha256sum yt-live-chat-overlay.user.js yt-live-chat-overlay.meta.js > checksums.txt && cd ..

          # Create metadata
          cat > release/metadata.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "build_date": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "commit": "${{ github.sha }}",
            "node_version": "${{ env.NODE_VERSION }}"
          }
          EOF

          # Extract changelog for current version
          CHANGELOG_CONTENT=""
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG_CONTENT=$(awk -v ver="${{ steps.version.outputs.version }}" '
              /^## \[/ {
                if (found) exit;
                if ($0 ~ "\\[" ver "\\]") {
                  found=1;
                  next;
                }
              }
              found { print }
            ' CHANGELOG.md)
          fi

          # Create release notes with changelog content
          PREV_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -v "^v${{ steps.version.outputs.version }}$" | head -n 1 || true)
          if [ -n "$PREV_TAG" ]; then
            COMPARE_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ steps.version.outputs.version }}"
          else
            COMPARE_URL="https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          fi

          cat > release/RELEASE_NOTES.md << EOF
          # üöÄ Release v${{ steps.version.outputs.version }}

          ## üì• Installation

          **[üì• Click here to install](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/yt-live-chat-overlay.user.js)**

          ---

          ## üìù What's Changed

          ${CHANGELOG_CONTENT:-No changelog entry found for this version.}

          **[üìã Full Changelog](${COMPARE_URL})**

          ---

          ## üìã Build Details

          - **Commit**: \`${{ github.sha }}\`
          - **Built**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Node.js**: \`${{ env.NODE_VERSION }}\`
          EOF

      - name: üì§ Deploy dist/ to release branch
        run: |
          set -euo pipefail

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if release branch exists remotely
          if git ls-remote --heads origin release | grep -q release; then
            echo "üì¶ Fetching existing release branch..."
            git fetch origin release:release
            git checkout release
          else
            echo "üì¶ Creating new orphan release branch..."
            git checkout --orphan release
            git rm -rf . || true
            echo "# Release Branch" > README.md
            echo "" >> README.md
            echo "This branch contains only the built userscript files for jsDelivr CDN." >> README.md
            echo "" >> README.md
            echo "**Do not commit to this branch manually.**" >> README.md
            echo "" >> README.md
            echo "Files are automatically updated by GitHub Actions on each release." >> README.md
            git add README.md
            git commit -m "chore: initialize release branch"
          fi

          # Copy built files from backup (user.js + meta.js for jsDelivr CDN)
          mkdir -p dist
          cp /tmp/dist-backup/yt-live-chat-overlay.user.js dist/
          cp /tmp/dist-backup/yt-live-chat-overlay.meta.js dist/

          # Add and commit
          git add dist/yt-live-chat-overlay.user.js dist/yt-live-chat-overlay.meta.js

          if git diff --staged --quiet; then
            echo "üì¶ No changes to dist/ files"
          else
            git commit -m "chore: update dist/ for v${{ steps.version.outputs.version }}"
            git push origin release
            echo "‚úÖ dist/ deployed to release branch"
          fi

      - name: üîÑ Purge jsDelivr CDN cache
        run: |
          echo "üîÑ Purging jsDelivr CDN cache..."

          # Purge main userscript file
          PURGE_URL_USER="https://purge.jsdelivr.net/gh/${{ github.repository }}@release/dist/yt-live-chat-overlay.user.js"
          echo "Purging: $PURGE_URL_USER"
          curl -s "$PURGE_URL_USER" | jq '.' || echo "Purge request sent"

          # Purge meta.js file
          PURGE_URL_META="https://purge.jsdelivr.net/gh/${{ github.repository }}@release/dist/yt-live-chat-overlay.meta.js"
          echo "Purging: $PURGE_URL_META"
          curl -s "$PURGE_URL_META" | jq '.' || echo "Purge request sent"

          echo "‚úÖ jsDelivr cache purge completed"

      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          body_path: release/RELEASE_NOTES.md
          files: |
            release/yt-live-chat-overlay.user.js
            release/yt-live-chat-overlay.meta.js
            release/checksums.txt
            release/metadata.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìä Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-v${{ steps.version.outputs.version }}
          path: release/
          retention-days: 30
