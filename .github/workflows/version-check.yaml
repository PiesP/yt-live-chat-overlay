name: ðŸ” Workflow Tools Version Check

# Responsibility: Check for updates to tools used in workflows
# - OSV Scanner reusable workflow version
# - Creates PR when update is available
#
# Trigger: Weekly schedule + manual trigger

on:
  schedule:
    - cron: "0 2 * * 1" # Weekly on Mondays at 2 AM UTC (after dependency checks)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: version-check
  cancel-in-progress: true

jobs:
  check-versions:
    name: ðŸ” Check Workflow Tool Versions
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ” Check OSV Scanner version
        id: osv
        run: |
          set -euo pipefail
          # Get current OSV Scanner version from workflow file
          CURRENT_VERSION=$(grep 'osv-scanner-action.*@v' .github/workflows/security.yaml | grep -oP '@v\K[0-9.]+' | head -1)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get latest OSV Scanner release from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/google/osv-scanner-action/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ OSV Scanner: Current=v$CURRENT_VERSION, Latest=v$LATEST_VERSION"

          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ› ï¸ Update workflow version pins
        if: steps.osv.outputs.needs_update == 'true'
        run: |
          set -euo pipefail
          TARGET_VERSION='${{ steps.osv.outputs.latest }}'

          perl -i -pe "s#(osv-scanner-reusable\.yml)@v[0-9.]+#\\$1@v${TARGET_VERSION}#g" .github/workflows/security.yaml
          perl -i -pe "s#(osv-scanner-reusable-pr\.yml)@v[0-9.]+#\\$1@v${TARGET_VERSION}#g" .github/workflows/security.yaml

          echo "âœ… Updated security workflow to OSV Scanner v${TARGET_VERSION}"

      - name: ðŸ“Š Generate summary
        run: |
          set -euo pipefail
          echo "## ðŸ” Workflow Tools Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Tool | Current Version | Latest Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.osv.outputs.needs_update }}" == "true" ]; then
            echo "| OSV Scanner | ${{ steps.osv.outputs.current }} | ${{ steps.osv.outputs.latest }} | â¬†ï¸ Update available |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| OSV Scanner | ${{ steps.osv.outputs.current }} | ${{ steps.osv.outputs.latest }} | âœ… Up to date |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¬ Create/update automated PR
        id: create-pr
        if: steps.osv.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ci(deps): bump OSV scanner to v${{ steps.osv.outputs.latest }}"
          title: "ci(deps): bump OSV scanner to v${{ steps.osv.outputs.latest }}"
          body: |
            ## ðŸ”„ Automated workflow dependency update

            - Updated OSV Scanner reusable workflow version in `security.yaml`
            - From: `v${{ steps.osv.outputs.current }}`
            - To: `v${{ steps.osv.outputs.latest }}`

            This PR was created automatically by `version-check.yaml`.
          branch: chore/workflow-tool-updates
          delete-branch: true
          labels: ci,dependencies,automated,automerge
          add-paths: .github/workflows/security.yaml

      - name: ðŸ¤– Queue auto-merge for generated PR
        if: steps.create-pr.outputs.pull-request-url != ''
        run: |
          set -euo pipefail
          gh pr merge --auto --squash "${{ steps.create-pr.outputs.pull-request-url }}"
          echo "âœ… Auto-merge queued for ${{ steps.create-pr.outputs.pull-request-url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
